http:
  routers:
    # Static IP Host-based routing (HIGH PRIORITY)
    static-ip-root:
      rule: "Host(`103.217.173.158`) && Path(`/`)"
      service: default-service
      priority: 200

    static-ip-jenkins:
      rule: "Host(`103.217.173.158`) && PathPrefix(`/jenkins`)"
      service: jenkins-service
      middlewares:
        - jenkins-headers
      priority: 200

    static-ip-project1:
      rule: "Host(`103.217.173.158`) && PathPrefix(`/project1`)"
      service: project1-service
      middlewares:
        - project1-stripprefix
      priority: 200

    static-ip-project2:
      rule: "Host(`103.217.173.158`) && PathPrefix(`/project2`)"
      service: project2-service
      middlewares:
        - project2-stripprefix
      priority: 200

    static-ip-traefik:
      rule: "Host(`103.217.173.158`) && PathPrefix(`/dashboard`)"
      service: api@internal
      priority: 200

    static-ip-traefik-api:
      rule: "Host(`103.217.173.158`) && PathPrefix(`/api`)"
      service: api@internal
      priority: 200

    static-ip-grafana:
      rule: "Host(`103.217.173.158`) && PathPrefix(`/grafana`)"
      service: k6-grafana-service
      middlewares:
        - grafana-stripprefix
      priority: 200

    static-ip-prometheus:
      rule: "Host(`103.217.173.158`) && PathPrefix(`/prometheus`)"
      service: prometheus-service
      middlewares:
        - prometheus-stripprefix
      priority: 200

    static-ip-k6:
      rule: "Host(`103.217.173.158`) && PathPrefix(`/k6`)"
      service: k6-dashboard-service
      middlewares:
        - k6-dashboard-stripprefix
      priority: 200

    # Router untuk Jenkins (akses via IP - fallback)
    jenkins:
      rule: "PathPrefix(`/jenkins`)"
      service: jenkins-service
      middlewares:
        - jenkins-headers
      priority: 100

    # Router untuk project lainnya (fallback)
    project1:
      rule: "PathPrefix(`/project1`)"
      service: project1-service
      middlewares:
        - project1-stripprefix
      priority: 100

    project2:
      rule: "PathPrefix(`/project2`)"
      service: project2-service
      middlewares:
        - project2-stripprefix
      priority: 100

    # K6 Dashboard router (k6.localhost subdomain - fallback)
    k6-dashboard:
      rule: "Host(`k6.localhost`)"
      service: k6-dashboard-service
      priority: 90

    # K6 Dashboard router - Path-based for IP access (fallback)
    k6-dashboard-ip:
      rule: "PathPrefix(`/k6`)"
      service: k6-dashboard-service
      middlewares:
        - k6-dashboard-stripprefix
      priority: 90

    # K6 Grafana integration - Host-based (fallback)
    k6-grafana:
      rule: "Host(`k6.localhost`) && PathPrefix(`/grafana`)"
      service: k6-grafana-service
      priority: 90

    # Grafana router - Path-based for IP access (fallback)
    grafana-ip:
      rule: "PathPrefix(`/grafana`)"
      service: k6-grafana-service
      middlewares:
        - grafana-stripprefix
      priority: 90

    # Prometheus router - Path-based for IP access (fallback)
    prometheus-ip:
      rule: "PathPrefix(`/prometheus`)"
      service: prometheus-service
      middlewares:
        - prometheus-stripprefix
      priority: 90

  middlewares:
    jenkins-headers:
      headers:
        customRequestHeaders:
          X-Forwarded-Proto: "http"
          X-Forwarded-Port: "58002"
        
    project1-stripprefix:
      stripPrefix:
        prefixes:
          - "/project1"

    project2-stripprefix:
      stripPrefix:
        prefixes:
          - "/project2"

    # New middleware for Grafana path stripping
    grafana-stripprefix:
      stripPrefix:
        prefixes:
          - "/grafana"

    # New middleware for Prometheus path stripping
    prometheus-stripprefix:
      stripPrefix:
        prefixes:
          - "/prometheus"

    # New middleware for K6 Dashboard path stripping
    k6-dashboard-stripprefix:
      stripPrefix:
        prefixes:
          - "/k6"

    k6-cors:
      headers:
        accessControlAllowMethods:
          - GET
          - OPTIONS
          - PUT
          - POST
          - DELETE
        accessControlAllowOriginList:
          - "*"
        accessControlAllowHeaders:
          - "*"

  services:
    # Default landing page service
    default-service:
      loadBalancer:
        servers:
          - url: "http://default-app:80"

    jenkins-service:
      loadBalancer:
        servers:
          - url: "http://jenkins:8080"

    project1-service:
      loadBalancer:
        servers:
          - url: "http://project1-app:3000"

    project2-service:
      loadBalancer:
        servers:
          - url: "http://project2-app:8000"

    k6-dashboard-service:
      loadBalancer:
        servers:
          - url: "http://k6-dashboard:3001"

    k6-grafana-service:
      loadBalancer:
        servers:
          - url: "http://grafana:3000"

    # Prometheus service for path-based access
    prometheus-service:
      loadBalancer:
        servers:
          - url: "http://prometheus:9090"